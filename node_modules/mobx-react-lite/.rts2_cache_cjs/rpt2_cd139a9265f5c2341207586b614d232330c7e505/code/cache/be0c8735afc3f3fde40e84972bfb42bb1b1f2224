{"code":"export function createTrackingData(reaction) {\r\n    const trackingData = {\r\n        cleanAt: Date.now() + CLEANUP_LEAKED_REACTIONS_AFTER_MILLIS,\r\n        reaction\r\n    };\r\n    return trackingData;\r\n}\r\n/**\r\n * The minimum time before we'll clean up a Reaction created in a render\r\n * for a component that hasn't managed to run its effects. This needs to\r\n * be big enough to ensure that a component won't turn up and have its\r\n * effects run without being re-rendered.\r\n */\r\nexport const CLEANUP_LEAKED_REACTIONS_AFTER_MILLIS = 10000;\r\n/**\r\n * The frequency with which we'll check for leaked reactions.\r\n */\r\nexport const CLEANUP_TIMER_LOOP_MILLIS = 10000;\r\n/**\r\n * Reactions created by components that have yet to be fully mounted.\r\n */\r\nconst uncommittedReactionRefs = new Set();\r\n/**\r\n * Latest 'uncommitted reactions' cleanup timer handle.\r\n */\r\nlet reactionCleanupHandle;\r\nfunction ensureCleanupTimerRunning() {\r\n    if (reactionCleanupHandle === undefined) {\r\n        reactionCleanupHandle = setTimeout(cleanUncommittedReactions, CLEANUP_TIMER_LOOP_MILLIS);\r\n    }\r\n}\r\nexport function scheduleCleanupOfReactionIfLeaked(ref) {\r\n    uncommittedReactionRefs.add(ref);\r\n    ensureCleanupTimerRunning();\r\n}\r\nexport function recordReactionAsCommitted(reactionRef) {\r\n    uncommittedReactionRefs.delete(reactionRef);\r\n}\r\n/**\r\n * Run by the cleanup timer to dispose any outstanding reactions\r\n */\r\nfunction cleanUncommittedReactions() {\r\n    reactionCleanupHandle = undefined;\r\n    // Loop through all the candidate leaked reactions; those older\r\n    // than CLEANUP_LEAKED_REACTIONS_AFTER_MILLIS get tidied.\r\n    const now = Date.now();\r\n    for (const ref of uncommittedReactionRefs) {\r\n        const tracking = ref.current;\r\n        if (tracking) {\r\n            if (now >= tracking.cleanAt) {\r\n                // It's time to tidy up this leaked reaction.\r\n                tracking.reaction.dispose();\r\n                ref.current = null;\r\n                uncommittedReactionRefs.delete(ref);\r\n            }\r\n        }\r\n    }\r\n    if (uncommittedReactionRefs.size > 0) {\r\n        // We've just finished a round of cleanups but there are still\r\n        // some leak candidates outstanding.\r\n        ensureCleanupTimerRunning();\r\n    }\r\n}\r\n/* istanbul ignore next */\r\n/**\r\n * Only to be used by test functions; do not export outside of mobx-react-lite\r\n */\r\nexport function forceCleanupTimerToRunNowForTests() {\r\n    // This allows us to control the execution of the cleanup timer\r\n    // to force it to run at awkward times in unit tests.\r\n    if (reactionCleanupHandle) {\r\n        clearTimeout(reactionCleanupHandle);\r\n        cleanUncommittedReactions();\r\n    }\r\n}\r\n/* istanbul ignore next */\r\nexport function resetCleanupScheduleForTests() {\r\n    if (reactionCleanupHandle) {\r\n        clearTimeout(reactionCleanupHandle);\r\n        reactionCleanupHandle = undefined;\r\n    }\r\n    uncommittedReactionRefs.clear();\r\n}\r\n//# sourceMappingURL=reactionCleanupTracking.js.map","references":["D:/workspace/github/mobx-react-lite/node_modules/mobx/lib/mobx.d.ts"],"map":"{\"version\":3,\"file\":\"reactionCleanupTracking.js\",\"sourceRoot\":\"\",\"sources\":[\"../../src/reactionCleanupTracking.ts\"],\"names\":[],\"mappings\":\"AAwBA,MAAM,UAAU,kBAAkB,CAAC,QAAkB;IACjD,MAAM,YAAY,GAAsB;QACpC,OAAO,EAAE,IAAI,CAAC,GAAG,EAAE,GAAG,qCAAqC;QAC3D,QAAQ;KACX,CAAA;IACD,OAAO,YAAY,CAAA;AACvB,CAAC;AAED;;;;;GAKG;AACH,MAAM,CAAC,MAAM,qCAAqC,GAAG,KAAM,CAAA;AAE3D;;GAEG;AACH,MAAM,CAAC,MAAM,yBAAyB,GAAG,KAAM,CAAA;AAE/C;;GAEG;AACH,MAAM,uBAAuB,GAA0D,IAAI,GAAG,EAAE,CAAA;AAEhG;;GAEG;AACH,IAAI,qBAAgE,CAAA;AAEpE,SAAS,yBAAyB;IAC9B,IAAI,qBAAqB,KAAK,SAAS,EAAE;QACrC,qBAAqB,GAAG,UAAU,CAAC,yBAAyB,EAAE,yBAAyB,CAAC,CAAA;KAC3F;AACL,CAAC;AAED,MAAM,UAAU,iCAAiC,CAC7C,GAAqD;IAErD,uBAAuB,CAAC,GAAG,CAAC,GAAG,CAAC,CAAA;IAEhC,yBAAyB,EAAE,CAAA;AAC/B,CAAC;AAED,MAAM,UAAU,yBAAyB,CACrC,WAA6D;IAE7D,uBAAuB,CAAC,MAAM,CAAC,WAAW,CAAC,CAAA;AAC/C,CAAC;AAED;;GAEG;AACH,SAAS,yBAAyB;IAC9B,qBAAqB,GAAG,SAAS,CAAA;IAEjC,+DAA+D;IAC/D,yDAAyD;IAEzD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;IACtB,KAAK,MAAM,GAAG,IAAI,uBAAuB,EAAE;QACvC,MAAM,QAAQ,GAAG,GAAG,CAAC,OAAO,CAAA;QAC5B,IAAI,QAAQ,EAAE;YACV,IAAI,GAAG,IAAI,QAAQ,CAAC,OAAO,EAAE;gBACzB,6CAA6C;gBAC7C,QAAQ,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAA;gBAC3B,GAAG,CAAC,OAAO,GAAG,IAAI,CAAA;gBAClB,uBAAuB,CAAC,MAAM,CAAC,GAAG,CAAC,CAAA;aACtC;SACJ;KACJ;IAED,IAAI,uBAAuB,CAAC,IAAI,GAAG,CAAC,EAAE;QAClC,8DAA8D;QAC9D,oCAAoC;QACpC,yBAAyB,EAAE,CAAA;KAC9B;AACL,CAAC;AAED,0BAA0B;AAC1B;;GAEG;AACH,MAAM,UAAU,iCAAiC;IAC7C,+DAA+D;IAC/D,qDAAqD;IACrD,IAAI,qBAAqB,EAAE;QACvB,YAAY,CAAC,qBAAqB,CAAC,CAAA;QACnC,yBAAyB,EAAE,CAAA;KAC9B;AACL,CAAC;AAED,0BAA0B;AAC1B,MAAM,UAAU,4BAA4B;IACxC,IAAI,qBAAqB,EAAE;QACvB,YAAY,CAAC,qBAAqB,CAAC,CAAA;QACnC,qBAAqB,GAAG,SAAS,CAAA;KACpC;IACD,uBAAuB,CAAC,KAAK,EAAE,CAAA;AACnC,CAAC\"}","dts":{"name":"D:/workspace/github/mobx-react-lite/reactionCleanupTracking.d.ts","writeByteOrderMark":false,"text":"/// <reference types=\"react\" />\r\nimport { Reaction } from \"mobx\";\r\nexport interface IReactionTracking {\r\n    /** The Reaction created during first render, which may be leaked */\r\n    reaction: Reaction;\r\n    /**\r\n     * The time (in ticks) at which point we should dispose of the reaction\r\n     * if this component hasn't yet been fully mounted.\r\n     */\r\n    cleanAt: number;\r\n    /**\r\n     * Whether the component has yet completed mounting (for us, whether\r\n     * its useEffect has run)\r\n     */\r\n    mounted?: boolean;\r\n    /**\r\n     * Whether the observables that the component is tracking changed between\r\n     * the first render and the first useEffect.\r\n     */\r\n    changedBeforeMount?: boolean;\r\n}\r\nexport declare function createTrackingData(reaction: Reaction): IReactionTracking;\r\n/**\r\n * The minimum time before we'll clean up a Reaction created in a render\r\n * for a component that hasn't managed to run its effects. This needs to\r\n * be big enough to ensure that a component won't turn up and have its\r\n * effects run without being re-rendered.\r\n */\r\nexport declare const CLEANUP_LEAKED_REACTIONS_AFTER_MILLIS = 10000;\r\n/**\r\n * The frequency with which we'll check for leaked reactions.\r\n */\r\nexport declare const CLEANUP_TIMER_LOOP_MILLIS = 10000;\r\nexport declare function scheduleCleanupOfReactionIfLeaked(ref: React.MutableRefObject<IReactionTracking | null>): void;\r\nexport declare function recordReactionAsCommitted(reactionRef: React.MutableRefObject<IReactionTracking | null>): void;\r\n/**\r\n * Only to be used by test functions; do not export outside of mobx-react-lite\r\n */\r\nexport declare function forceCleanupTimerToRunNowForTests(): void;\r\nexport declare function resetCleanupScheduleForTests(): void;\r\n"}}
